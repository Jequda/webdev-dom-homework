<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <div class="page-loader" id="page-loader"></div>
      <ul class="comments" id="comments"></ul>
      <div class="comment-loader" id="comment-loader"></div>
      <div class="add-form" id="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="name-input"
          onchange="error()"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          id="text-input"
          onchange="error()"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="add-button">Написать</button>
        </div>
      </div>
    </div>
  </body>
  <style>
    .error {
      background-color: cyan;
    }
  </style>
  <script>
    "use strict";
    const buttonElement = document.getElementById("add-button");
    const listElement = document.getElementById("comments");
    const nameInputElement = document.getElementById("name-input");
    const textInputElement = document.getElementById("text-input");
    const commentElement = document.getElementById("comments");
    const loadElement = document.getElementById("page-loader");
    const commentLoadElement = document.getElementById("comment-loader");
    const addFormElement = document.getElementById("add-form");

    buttonElement.disabled = true;
    loadElement.textContent = "Комментарии загружаются...";

    const fetchAndRenderTasks = () => {
      return fetch(
        "https://wedev-api.sky.pro/api/v1/yaroslav-sakhno/comments",
        {
          method: "GET",
        }
      )
        .then((response) => response.json())
        .then((responseData) => {
          comments = responseData.comments.map((comment) => {
            return {
              name: comment.author.name,
              date: formatDateTime(comment.date),
              id: comment.id,
              isLiked: comment.isLiked,
              likes: comment.likes,
              text: comment.text,
            };
          });
          renderComment();
        })
        .then(() => {
          loadElement.textContent = "";
        });
    };

    let comments = [
      // {
      //   name: "Глеб Фокин",
      //   date: "12.02.22 12:18",
      //   text: "Это будет первый комментарий на этой странице",
      //   likes: 3,
      //   isLiked: false,
      // },
      // {
      //   name: "Варвара Н.",
      //   date: "13.02.22 19:22",
      //   text: "Мне нравится как оформлена эта страница! ❤",
      //   likes: 75,
      //   isLiked: false,
      // },
    ];

    const renderComment = () => {
      const commentHTML = comments
        .map((comment, index) => {
          return `<li class="comment" data-name="${comment.name}" data-text="${
            comment.text
          }">
                <div class="comment-header">
                  <div>${comment.name}</div>
                  <div>${comment.date}</div>
                </div>
                <div class="comment-body" >
                  <div class="comment-text">${comment.text}</div>
                </div>
                <div class="comment-footer">
                  <div class="likes">
                    <span class="likes-counter">${comment.likes}</span>
                    <button class="like-button ${
                      comment.isLiked ? "-active-like" : ""
                    }" data-index="${index}"></button>
                  </div>
                </div>
              </li>`;
        })
        .join("");

      listElement.innerHTML = commentHTML;
      initLikeListeners();
    };

    const initLikeListeners = () => {
      const commentElement = document.querySelectorAll(".comment");
      for (const comment of commentElement) {
        comment.addEventListener("click", () => {
          const text = comment.dataset.text;
          const name = comment.dataset.name;
          textInputElement.value = `QUOTE_BEGIN ${name}:\n${text} QUOTE_END`;
        });
      }

      const likeButtons = document.querySelectorAll(".like-button");
      for (const likeButton of likeButtons) {
        likeButton.addEventListener("click", () => {
          event.stopPropagation();
          const index = likeButton.dataset.index;
          comments[index].likes += comments[index].isLiked ? -1 : +1;
          comments[index].isLiked = !comments[index].isLiked;

          renderComment();
        });
      }
    };

    const formatDateTime = (date) => {
      let dateTime = new Date(date);
      const day = String(dateTime.getDate()).padStart(2, "0");
      const month = String(dateTime.getMonth()).padStart(2, "0");
      const year = String(dateTime.getFullYear() - 2000);
      const minutes = String(dateTime.getMinutes()).padStart(2, "0");
      const hours = String(dateTime.getHours()).padStart(2, "0");
      return `${day}.${month}.${year} ${hours}:${minutes}`;
    };

    function error() {
      if (nameInputElement.value === "" && textInputElement.value === "") {
        nameInputElement.classList.add("error");
        textInputElement.classList.add("error");
        document.getElementById("add-button").disabled = true;
        return;
      } else if (nameInputElement.value === "") {
        nameInputElement.classList.add("error");
        document.getElementById("add-button").disabled = true;
        return;
      } else if (textInputElement.value === "") {
        textInputElement.classList.add("error");
        document.getElementById("add-button").disabled = true;
        return;
      } else {
        document.getElementById("add-button").disabled = false;
        nameInputElement.classList.remove("error");
        textInputElement.classList.remove("error");
      }
    }

    fetchAndRenderTasks();

    buttonElement.addEventListener("click", () => {
      const date = new Date();

      commentLoadElement.textContent = "Добавляется новый комментарий...";
      addFormElement.style.display = "none";

      fetch("https://wedev-api.sky.pro/api/v1/yaroslav-sakhno/comments", {
        method: "POST",
        body: JSON.stringify({
          name: nameInputElement.value
            .replaceAll("<", "&lt")
            .replaceAll(">", "&gt"),
          text: textInputElement.value
            .replaceAll("<", "&lt")
            .replaceAll(">", "&gt")
            .replaceAll("QUOTE_BEGIN", "<div class='quote'>")
            .replaceAll("QUOTE_END", "</div>"),
          date: formatDateTime(new Date()),
          isLiked: false,
          likes: 0,
        }),
      })
        .then(() => {
          return fetchAndRenderTasks();
        })
        .then(() => {
          commentLoadElement.textContent = "";
          addFormElement.style.display = "";
        });

      buttonElement.disabled = true;
      nameInputElement.value = "";
      textInputElement.value = "";
      renderComment();
    });

    console.log("It works!");

    renderComment();
  </script>
</html>
